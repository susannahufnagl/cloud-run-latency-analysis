
#Repo-Root=Verzeichnis dieser Datei ermitteln
if [ -n "${BASH_SOURCE:-}" ]; then _SELF="${BASH_SOURCE[0]}"; else _SELF="${(%):-%N}"; fi
REPO_ROOT="$(cd "$(dirname "$_SELF")" && pwd)"

vm() {
  #.env aus dem Repo-Root laden + exportieren
  if [[ -f "$REPO_ROOT/.env" ]]; then
    set -a; source "$REPO_ROOT/.env"; set +a
  else
    echo " .env nicht gefunden unter $REPO_ROOT/.env"; return 1
  fi
  : "${PROJECT:?PROJECT fehlt in .env}"
  : "${ZONE:?ZONE fehlt in .env}"
  : "${INSTANCE:?INSTANCE fehlt in .env}"

  case "${1:-}" in
    start)  gcloud compute instances start "$INSTANCE" --zone "$ZONE" --project "$PROJECT" ;;
    stop)   gcloud compute instances stop  "$INSTANCE" --zone "$ZONE" --project "$PROJECT" ;;
    ssh)    gcloud compute ssh "$INSTANCE" --zone "$ZONE" --project "$PROJECT" ;;
    ip)     gcloud compute instances describe "$INSTANCE" --zone "$ZONE" --project "$PROJECT" \
              --format='get(networkInterfaces[0].accessConfigs[0].natIP)' ;;
    health) gcloud compute ssh "$INSTANCE" --zone "$ZONE" --project "$PROJECT" \
              --command "curl -fsS http://127.0.0.1:8080/health || echo FAIL" ;;
    up)     gcloud compute instances start "$INSTANCE" --zone "$ZONE" --project "$PROJECT" && \
            gcloud compute instances describe "$INSTANCE" --zone "$ZONE" --project "$PROJECT" \
              --format='get(networkInterfaces[0].accessConfigs[0].natIP)' ;;
    *) echo "Usage: vm {start|stop|ssh|ip|health|up}" ;;
  esac
}

run_stage() {
  stage="${1:-}"
  [[ -z "$stage" ]] && { echo "Bitte Stage angeben, z.B run_stage SX"; return 1; }

  if [[ -f "$REPO_ROOT/.env" ]]; then
    set -a; source "$REPO_ROOT/.env"; set +a
  else
    echo ".env nicht gefunden unter $REPO_ROOT/.env"; return 1
  fi
  : "${CR_BASE:?CR_BASE fehlt in .env}"

  CURRENT_IP="$(gcloud compute instances describe "$INSTANCE" --zone "$ZONE" --project "$PROJECT" \
    --format='get(networkInterfaces[0].accessConfigs[0].natIP)')"
  export CE_BASE="http://${CURRENT_IP}:8080"
  echo "CE_BASE gesetzt auf $CE_BASE"

  export OUTDIR="$REPO_ROOT/Testresults/${stage}"
  mkdir -p "$OUTDIR"

  typeset script=""
  case "$stage" in
    all)
      echo "Starte alle Messungen (S0 + S0_independent)..."
      run_stage S0
      sleep 5
      run_stage S0_independent
      return 0
      ;;
    S0|S0_concurrent)
      script="$REPO_ROOT/scripts/run_all_concurrent_0.sh"
      ;;
    S0_independent|S0_stream)
      script="$REPO_ROOT/scripts/run_all_independent_0.sh"
      ;;
    *)
      echo "Unbekannte Stage: $stage"; return 1 ;;
  esac

  echo "Starte Messung: Stage=$stage  â†’ OUTDIR=$OUTDIR"
  bash "$script"
}
